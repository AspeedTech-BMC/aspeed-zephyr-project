# Certificate Chain Sample

The folder contains certificates and keys for testing.  
Preload firmware should verify certificate chain to check whether device id is provisioned.
Certificates are generated by following commands.

## Root CA

```
openssl genpkey -genparam -out param.pem -algorithm EC -pkeyopt ec_paramgen_curve:P-384
openssl req -nodes -x509 -days 3650 -newkey ec:param.pem -keyout ca.key -out ca.cert -sha384 -subj "/C=TW/O=Aspeed/CN=Aspeed Root CA"
```

## Intermediate Certificate

```
openssl req -nodes -newkey ec:param.pem -keyout inter.key -out inter.req -sha384 -batch -subj "/C=TW/O=Aspeed/CN=Aspeed intermediate cert"
openssl x509 -req -in inter.req -out inter.cert -CA ca.cert -CAkey ca.key -sha384 -days 3650 -set_serial 1 -extensions v3_inter -extfile ../openssl.cnf
```

## Leaf Certificate

```
openssl x509 -req -in devid.req -out leaf.cert -CA inter.cert -CAkey inter.key -sha384 -days 3650 -set_serial 3 -extensions v3_end -extfile ../openssl.cnf
```

devid.req is Device ID certificate request, please refer to [Device ID Certificate Request](#device-id-certificate-request)

## Certificate chain

```
openssl asn1parse -in ca.cert -out ca.cert.der
openssl asn1parse -in inter.cert -out inter.cert.der
openssl asn1parse -in leaf.cert -out leaf.cert.der
cat ca.cert.der inter.cert.der leaf.cert.der > certchain.der
```

## Device ID Certificate Request
Device ID certificate request(devid.req) is generated in first mutable code(mcuboot).  
Device ID certificate request(devid.reg) is signed by Device ID private key.  
Device ID private key is derived by CDI, in this sample, the value of CDI is all zero.  

## Test Step
The test step put certificate chain in BMC flash to test the flow of certificate chain replacement.

### Prerequisite
AST1060 mcuboot has generated Device ID CSR and Alias Certificate and put them in internal flash offset 0x1c000.

### Steps
1. Put certchain.der to ast2600-dcscm mtd14(0xd320000) before runing preload firmware

```
flashcp -v certchain.der /dev/mtd14
```

2. Bootup AST1060 with preload firmware, if certificate in AST1060 internal flash is CSR, preload firmware sends CSR to HSM for device id provisioning.

```
[00:00:00.095,000] <inf> main: *** ASPEED Preload FW version v01.01 Board:ast1060_dcscm ***
[00:00:00.097,000] <inf> main: Sending DeviceID certificate request to HSM...
[00:00:00.686,000] <inf> cert: Certificate chain verify successful
[00:00:00.680,000] <inf> main: Replace CSR by certificate chain
```

3. Bootup AST1060 preload firmware again, it verifies certificate chain, initializes mailbox commands for ROT firmware replacement.
```
[00:00:00.095,000] <inf> main: *** ASPEED Preload FW version v01.01 Board:ast1060_dcscm ***
[00:00:00.098,000] <inf> main: Verify certificate chain...
[00:00:00.685,000] <inf> cert: Certificate chain verify successful
[00:00:00.721,000] <inf> gpio_ctrl: release BMC
[00:00:00.746,000] <inf> gpio_ctrl: release PCH
[00:00:00.746,000] <inf> main: Ready for ROT firmware replacement
```
